<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dona - ERGO4ONE | Sostieni la Nostra Missione</title>
    <meta name="description" content="Sostieni ERGO4ONE e contribuisci al cambiamento sociale attraverso le donazioni di token Ergo (ERG). Ogni contributo è importante.">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "ERGO4ONE",
      "url": "https://yourwebsite.com",
      "logo": "https://i.ibb.co/5Y6fP4Z/ergo.jpg",
      "contactPoint": {
        "@type": "ContactPoint",
        "telephone": "+1234567890",
        "contactType": "Customer Service"
      }
    }
    </script>
</head>
<body>
    <!-- Include lo stesso header e menu di index.html -->

    <!-- Sezione Dona -->
    <section id="donate">
        <div class="container">
            <h2>Sostieni la Nostra Missione</h2>
            <p>Aiuta a costruire un'economia decentralizzata ed equa donando token Ergo (ERG). Ogni contributo dà potere agli individui e alle piccole imprese.</p>
            <input id="amount" type="number" class="form-control w-50 d-inline-block" placeholder="Inserisci l'importo in ERG" min="1">
            <button class="btn btn-primary" onclick="sendContribution()">Contribuisci</button>
            <button class="btn btn-danger" onclick="closeCampaign()">Chiudi Campagna</button> <!-- Solo amministratore -->
            <button class="btn btn-warning" onclick="requestRefund()">Chiedi Rimborso</button> <!-- Solo per contributori -->
        </div>
    </section>

    <!-- Script per interagire con Ergo -->
    <script src="https://cdn.jsdelivr.net/npm/ergo-lib-wasm-browser/ergo_lib_wasm.js"></script>
    <script>
        const adminAddress = "indirizzo_amministratore"; // Sostituire con l'indirizzo dell'amministratore

        async function closeCampaign() {
            const ctx = await ergoConnector.nautilus.getContext();
            const userAddress = await ctx.get_change_address();

            if (userAddress !== adminAddress) {
                alert('Solo l\'amministratore può chiudere la campagna.');
                return;
            }

            const utxos = await ctx.get_utxos(1000000); 

            const tx = await ctx.sign_tx({
                inputs: utxos,
                outputs: [
                    {
                        value: 1000000,
                        address: userAddress,
                        additionalRegisters: {}
                    }
                ],
                fee: 1000000,
                changeAddress: userAddress
            });

            const txId = await ctx.submit_tx(tx);
            console.log("ID transazione di chiusura inviata:", txId);
            alert('La campagna è stata chiusa manualmente dall\'amministratore.');
        }

        async function requestRefund() {
            const ctx = await ergoConnector.nautilus.getContext();
            const userAddress = await ctx.get_change_address();

            const isGoalReached = false; 
            if (isGoalReached) {
                alert('Non è possibile richiedere un rimborso: la campagna ha raggiunto il suo obiettivo.');
                return;
            }

            const utxos = await ctx.get_utxos(); 

            const tx = await ctx.sign_tx({
                inputs: utxos,
                outputs: [
                    {
                        value: utxos.reduce((acc, utxo) => acc + utxo.value, 0),
                        address: userAddress,
                        additionalRegisters: {}
                    }
                ],
                fee: 1000000,
                changeAddress: userAddress
            });

            const txId = await ctx.submit_tx(tx);
            console.log("ID transazione di rimborso inviata:", txId);
            alert('Il tuo contributo è stato rimborsato.');
        }
    </script>

    <!-- Include lo stesso footer di index.html -->
</body>
</html>
